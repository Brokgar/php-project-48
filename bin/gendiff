#!/usr/bin/php
<?php

namespace Hexlet\Gendiff;

require_once __DIR__ . '/../vendor/autoload.php';

/**
 * Основная функция для работы из командной строки
 */
function main($argv)
{
    // Удаляем имя скрипта из аргументов
    array_shift($argv);

    if (in_array('-h', $argv) || in_array('--help', $argv)) {
        showHelp();
        exit(0);
    }

    $options = [];
    $files = [];

    for ($i = 0; $i < count($argv); $i++) {
        $arg = $argv[$i];

        if ($arg === '-f' || $arg === '--format') {
            if ($i + 1 < count($argv)) {
                $options['format'] = $argv[$i + 1];
                $i++;
            } else {
                echo "Ошибка: опция -f/--format требует указания формата\n";
                exit(1);
            }
        } elseif ($arg === '--color') {
            $options['color'] = true;
        } else {
            $files[] = $arg;
        }
    }

    if (count($files) !== 2) {
        echo "Ошибка: необходимо указать ровно два файла для сравнения\n";
        echo "Использование: gendiff [ОПЦИИ] <файл1> <файл2>\n";
        exit(1);
    }

    try {
        $result = Gendiff::compareFiles($files[0], $files[1], $options);
        echo $result;
    } catch (\Exception $e) {
        echo "Ошибка: " . $e->getMessage() . "\n";
        exit(1);
    }
}

/**
 * Вывод справки по использованию
 */
function showHelp()
{
    $helpText = <<<HELP
Использование: gendiff [ОПЦИИ] <файл1> <файл2>

Сравнивает два конфигурационных файла JSON и показывает различия.

ОПЦИИ:
  -h, --help             Показать эту справку
  -f, --format <тип>    Формат вывода (plain, stylish, json)
  --color                Цветной вывод (если поддерживается)

ПРИМЕРЫ:
  gendiff file1.json file2.json
  gendiff -f stylish config1.json config2.json --color
  gendiff --help

ДОСТУПНЫЕ ФОРМАТЫ:
  plain   - Простой текстовый формат, только изменения
  stylish - Красивый формат с отступами и иконками
  json    - JSON‑представление различий
HELP;

    echo $helpText . "\n";
}

// Точка входа при запуске из консоли
main($argv);
